# see https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases
jobs:

# Provide a name for the job
- job: Linux
  displayName: ubuntu
  timeoutInMinutes: 0
  strategy:
    matrix: 
      a1:
        architecure: arch-qoriq-6.1
      a2:
        architecure: arch-kvmx64-6.1
      a3:
        architecure: arch-armv7-6.1
      a4:
        architecure: arch-denverton-6.1
      a5:
        architecure: arch-x64-6.1
      a6:
        architecure: arch-broadwell-6.1
      a7:
        architecure: arch-aarch64-6.1
      a8:
        architecure: arch-avoton-6.1
      a9:
        architecure: arch-armada38x-6.1
      a10:
        architecure: arch-x86-6.1
      a11:
        architecure: arch-88f6281-6.1
      a12:
        architecure: arch-grantley-6.1
      a13:
        architecure: arch-braswell-6.1
      a14:
        architecure: arch-comcerto2k-6.1
      a15:
        architecure: arch-armadaxp-6.1
      a16:
        architecure: arch-hi3535-6.1
      a17:
        architecure: arch-dockerx64-6.1
      a18:
        architecure: arch-cedarview-6.1
      a19:
        architecure: arch-armada375-6.1
      a20:
        architecure: arch-rtd1296-6.1
      a21:
        architecure: arch-monaco-6.1
      a22:
        architecure: arch-apollolake-6.1
      a23:
        architecure: arch-bromolow-6.1
      a24:
        architecure: arch-alpine-6.1
      a25:
        architecure: arch-armada370-6.1
      a26:
        architecure: arch-evansport-6.1    
    maxParallel: 10

  pool:
    vmImage: 'ubuntu-latest'

  steps:
    - script: sudo dpkg --add-architecture i386 && sudo apt-get update
      displayName: 'apt add architecture'

    - script: sudo apt install autogen automake bc bison build-essential check cmake curl cython debootstrap expect flex g++-multilib gettext git gperf imagemagick intltool libbz2-dev libc6-i386 libcppunit-dev libffi-dev libgc-dev libgmp3-dev libltdl-dev libmount-dev libncurses-dev libpcre3-dev libssl-dev libtool libunistring-dev lzip mercurial ncurses-dev php pkg-config python3 python3-distutils scons subversion swig unzip xmlto zlib1g-dev
      displayName: 'apt install'

    - script: python -m pip install --upgrade pip && pip install -U setuptools pip wheel httpie
      displayName: 'Install Python dependencies'
  

    - script: make setup
      displayName: 'make setup'

    - script: make $(architecure) 
      displayName: 'make $(architecure)'
      workingDirectory: spk/urbackup
  

    - task: GitHubRelease@1
      inputs:
        gitHubConnection: 'github'
        repositoryName: 'josef109/spksrc'
        action: 'create'
        target: '$(Build.SourceVersion)'
        tagSource: userSpecifiedTag
        tag: '2.4.12'
        assets: '$(Build.Repository.LocalPath)/packages/*.spk'
        addChangeLog: false


 
